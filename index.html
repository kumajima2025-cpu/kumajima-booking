<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>ç†Šå¶¼ï½œLINE é ç´„</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <style>
    :root{
      --bg:#FFF7ED;
      --card:#FFFFFF;
      --border:#F1D2BA;
      --text:#4A342E;
      --muted:#8B6F61;
      --latte:#C35A2E;
      --latte2:#E07A3F;
      --chip:#FFF1E7;
      --shadow:0 10px 28px rgba(36, 26, 22, .08);
      --radius:22px;
      --radius-sm:16px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      background:var(--bg);
      color:var(--text);
      font-family:-apple-system,BlinkMacSystemFont,"Noto Sans TC","PingFang TC","Heiti TC",sans-serif;
    }
    .wrap{max-width:720px;margin:0 auto;padding:18px 14px 40px;}
    .hero{
      padding:18px 16px 8px;
      display:flex;gap:12px;align-items:center;justify-content:space-between;
    }
    .brand{
      display:flex;flex-direction:column;gap:4px;
    }
    .brand h1{margin:0;font-size:20px;letter-spacing:.5px}
    .brand p{margin:0;color:var(--muted);font-size:13px}
    .badge{
      background:linear-gradient(135deg,var(--latte),var(--latte2));
      color:white;
      padding:8px 12px;border-radius:999px;
      font-weight:700;font-size:12px;
      box-shadow:0 10px 20px rgba(195,90,46,.18);
      white-space:nowrap;
    }
    .card{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:16px;
      margin:12px 0;
    }
    .row{display:flex;gap:10px;flex-wrap:wrap}
    label{font-size:12px;color:var(--muted);display:block;margin-bottom:6px}
    input,select,textarea{
      width:100%;
      border:1px solid var(--border);
      border-radius:14px;
      padding:12px 12px;
      background:#fff;
      color:var(--text);
      outline:none;
      font-size:14px;
    }
    textarea{min-height:86px;resize:vertical}
    .col{flex:1;min-width:180px}
    .slots{
      display:flex;flex-wrap:wrap;gap:10px;margin-top:10px;
    }
    .slot-btn{
      border:1px solid var(--border);
      background:var(--chip);
      color:var(--text);
      padding:10px 12px;
      border-radius:999px;
      cursor:pointer;
      font-weight:700;
      transition:.15s transform ease,.15s box-shadow ease,.15s background ease;
    }
    .slot-btn:hover{transform:translateY(-1px)}
    .slot-btn.active{
      background:linear-gradient(135deg,var(--latte),var(--latte2));
      color:#fff;
      border-color:transparent;
      box-shadow:0 10px 18px rgba(195,90,46,.18);
    }
    .muted{color:var(--muted);font-size:13px;line-height:1.6}
    .actions{display:flex;gap:10px;align-items:center;justify-content:space-between;margin-top:14px}
    .btn{
      border:none;
      background:linear-gradient(135deg,var(--latte),var(--latte2));
      color:white;
      padding:12px 14px;
      border-radius:16px;
      font-weight:800;
      cursor:pointer;
      width:100%;
      box-shadow:0 12px 22px rgba(195,90,46,.20);
    }
    .btn:disabled{opacity:.55;cursor:not-allowed}
    .small{font-size:12px;color:var(--muted)}
    .ok{
      padding:14px;
      border-radius:18px;
      background:#fff;
      border:1px dashed var(--border);
      line-height:1.7;
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="hero">
      <div class="brand">
        <h1>ç†Šå¶¼ï½œLINE é ç´„</h1>
        <p>ä¸€å°ä¸€æœå‹™ï½œå¯é¸æ™‚æ®µæœƒå³æ™‚è®Šå‹•</p>
      </div>
      <div class="badge">æš–æ©˜å¥¶æ²¹ç³» ğŸ¤</div>
    </div>

    <div class="card" id="card-main">
      <div class="row">
        <div class="col">
          <label>é¸æ“‡æœå‹™</label>
          <select id="service"></select>
        </div>
        <div class="col">
          <label>é¸æ“‡æ—¥æœŸ</label>
          <input id="date" type="date"/>
        </div>
      </div>

      <div style="margin-top:12px">
        <label>å¯é¸æ™‚æ®µï¼ˆé»ä¸€ä¸‹å°±é¸ï¼‰</label>
        <div class="muted" id="slot-hint">è«‹å…ˆé¸æœå‹™èˆ‡æ—¥æœŸï½</div>
        <div class="slots" id="slots"></div>
      </div>

      <div class="row" style="margin-top:14px">
        <div class="col">
          <label>é¡§å®¢å§“å</label>
          <input id="customer_name" placeholder="ä¾‹ï¼šç‹å°æ˜"/>
        </div>
        <div class="col">
          <label>æ‰‹æ©Ÿ</label>
          <input id="phone" inputmode="tel" placeholder="ä¾‹ï¼š09xxxxxxxx"/>
        </div>
      </div>

      <div class="row" style="margin-top:10px">
        <div class="col">
          <label>æ¯›å­©åå­—</label>
          <input id="pet_name" placeholder="ä¾‹ï¼šå¥¶æ²¹"/>
        </div>
        <div class="col">
          <label>å“ç¨®ï¼ˆå¯ä¸å¡«ï¼‰</label>
          <input id="pet_breed" placeholder="ä¾‹ï¼šæ¯”ç†Š"/>
        </div>
      </div>

      <div style="margin-top:10px">
        <label>å‚™è¨»ï¼ˆå¯ä¸å¡«ï¼‰</label>
        <textarea id="note" placeholder="ä¾‹ï¼šæ€•å¹é¢¨ã€çš®è†šæ•æ„Ÿã€æƒ³ç•™åœ“é ­â€¦"></textarea>
      </div>

      <div class="actions">
        <div class="small" id="me">è¼‰å…¥ LINE è³‡è¨Šä¸­â€¦</div>
        <button class="btn" id="submit" disabled>é€å‡ºé ç´„</button>
      </div>
    </div>

    <div class="card" id="card-result" style="display:none">
      <div class="ok" id="resultText"></div>
      <div style="margin-top:12px" class="muted">ä½ å¯ä»¥ç›´æ¥é—œé–‰æ­¤é é¢å›åˆ° LINE ğŸ¤</div>
    </div>
  </div>

<script>
  // ====== ä½ è¦æ”¹çš„ 2 å€‹åœ°æ–¹ ======
  const LIFF_ID = "2008905602-sYNLh7oj";
  const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbwzcXsBEZtxsabOgT3RL0NcDeH4UjxKsVdjleey-sENw6EaE-vvqI6IH7OGcLx6CvR_Rw/exec";

  // ====== state ======
  let profile = null;
  let selectedSlot = null; // {start_iso, end_iso, label}
  let services = [];

  // ====== helpers ======
  const $ = (id) => document.getElementById(id);

  function fmtDateYmd(d){
    const y = d.getFullYear();
    const m = String(d.getMonth()+1).padStart(2,'0');
    const da = String(d.getDate()).padStart(2,'0');
    return `${y}-${m}-${da}`;
  }

  function setHint(msg){ $("slot-hint").textContent = msg; }

  function setSubmitEnabled(){
    const ok =
      selectedSlot &&
      $("customer_name").value.trim() &&
      $("phone").value.trim() &&
      $("pet_name").value.trim() &&
      $("service").value;
    $("submit").disabled = !ok;
  }

  async function apiGet(route, params){
    const u = new URL(WEB_APP_URL);
    u.searchParams.set("route", route);
    Object.entries(params || {}).forEach(([k,v]) => u.searchParams.set(k, v));
    const res = await fetch(u.toString(), { method:"GET" });
    return res.json();
  }

  async function apiPost(route, body){
    const u = new URL(WEB_APP_URL);
    u.searchParams.set("route", route);
    const res = await fetch(u.toString(), {
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify(body || {})
    });
    return res.json();
  }

  function renderSlots(slots){
    const box = $("slots");
    box.innerHTML = "";
    selectedSlot = null;
    setSubmitEnabled();

    if (!slots || slots.length === 0){
      setHint("ä»Šå¤©æ²’æœ‰å¯é ç´„æ™‚æ®µï¼ˆæˆ–å·²é¡æ»¿ï¼‰ï¼Œæ›ä¸€å¤©çœ‹çœ‹ï½");
      return;
    }
    setHint("é¸ä¸€å€‹ä½ æƒ³è¦çš„æ™‚é–“ ğŸ¤");

    slots.forEach(s => {
      const b = document.createElement("button");
      b.type = "button";
      b.className = "slot-btn";
      b.textContent = s.label;

      b.addEventListener("click", () => {
        [...box.querySelectorAll(".slot-btn")].forEach(x => x.classList.remove("active"));
        b.classList.add("active");
        selectedSlot = s;
        setSubmitEnabled();
      });

      box.appendChild(b);
    });
  }

  async function refreshSlots(){
    const date = $("date").value;
    const svc = $("service").value;
    if (!date || !svc){
      $("slots").innerHTML = "";
      selectedSlot = null;
      setHint("è«‹å…ˆé¸æœå‹™èˆ‡æ—¥æœŸï½");
      setSubmitEnabled();
      return;
    }
    setHint("è¼‰å…¥å¯é ç´„æ™‚æ®µä¸­â€¦");
    const res = await apiGet("slots", { date, service: svc });
    if (!res.ok){
      setHint("è¼‰å…¥å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦");
      return;
    }
    renderSlots(res.slots);
  }

  async function init(){
    // æ—¥æœŸé è¨­ä»Šå¤©
    const today = new Date();
    $("date").value = fmtDateYmd(today);

    // LIFF init + profile
    await liff.init({ liffId: LIFF_ID });

if (!liff.isLoggedIn()) {
  liff.login({ redirectUri: location.href });
  return; // âœ… é€™å€‹ return è¶…é‡è¦
}

profile = await liff.getProfile();
$("me").textContent = `Hi ${profile.displayName} ğŸ‘‹`;

    // è®€æœå‹™
    async function apiGet(route, params){
  const u = new URL(WEB_APP_URL);
  u.searchParams.set("route", route);
  Object.entries(params || {}).forEach(([k,v]) => u.searchParams.set(k, v));

  const res = await fetch(u.toString(), { method:"GET" });
  const text = await res.text();

  let json;
  try { json = JSON.parse(text); }
  catch { throw new Error("API å›å‚³ä¸æ˜¯ JSONï¼š\n" + text.slice(0,200)); }

  if (!res.ok) throw new Error("API HTTP éŒ¯èª¤ï¼š" + res.status + "\n" + text.slice(0,200));
  return json;
}

    // ç¶äº‹ä»¶
    $("service").addEventListener("change", refreshSlots);
    $("date").addEventListener("change", refreshSlots);
    ["customer_name","phone","pet_name","note","pet_breed"].forEach(id =>
      $(id).addEventListener("input", setSubmitEnabled)
    );

    $("submit").addEventListener("click", async () => {
      $("submit").disabled = true;

      const payload = {
        line_user_id: profile.userId,
        line_display_name: profile.displayName,
        customer_name: $("customer_name").value.trim(),
        phone: $("phone").value.trim(),
        pet_name: $("pet_name").value.trim(),
        pet_breed: $("pet_breed").value.trim(),
        note: $("note").value.trim(),
        service_code: $("service").value,
        start_iso: selectedSlot.start_iso,
      };

      const res = await apiPost("book", payload);
      if (!res.ok){
        alert(res.error || "é ç´„å¤±æ•—ï¼Œè«‹å†è©¦ä¸€æ¬¡");
        await refreshSlots(); // å¤±æ•—ä¹Ÿé‡æ–°æŠ“ä¸€æ¬¡ï¼ˆå¯èƒ½è¢«æ¶èµ°ï¼‰
        setSubmitEnabled();
        return;
      }

      // æˆåŠŸç•«é¢
      $("card-main").style.display = "none";
      $("card-result").style.display = "block";
      $("resultText").textContent =
        `âœ… é ç´„å®Œæˆï¼\n\n` +
        `ä½ çš„é ç´„å·²æˆç«‹ï¼Œæˆ‘å€‘ä¹Ÿæœƒé€é LINE æ¨æ’­ã€Œé ç´„æˆåŠŸã€é€šçŸ¥ã€‚\n` +
        `ï¼ˆå‰ä¸€å¤©ä¹Ÿæœƒå†æé†’ä½ ä¸€æ¬¡ ğŸ¤ï¼‰\n\n` +
        `é ç´„ç·¨è™Ÿï¼š${res.booking_id}`;

      // å¯é¸ï¼šè‡ªå‹•é—œé–‰è¦–çª—ï¼ˆLIFFï¼‰
      // liff.closeWindow();
    });

    // åˆæ¬¡è¼‰å…¥ slotsï¼ˆç­‰æœå‹™é¸äº†å†æŠ“ï¼‰
    refreshSlots();
  }

  init().catch(err => {
  console.error(err);
  alert("åˆå§‹åŒ–å¤±æ•—ï¼š\n" + (err?.message || err));
});
</script>
</body>
</html>
